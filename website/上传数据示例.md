# 上传数据示例 - ContrailTracker

## 📊 示例1：通过网页上传数据

### 准备数据文件

#### 方式A：使用现有的示例数据（推荐）

你的项目中已经有现成的数据可以直接使用！

**卫星数据（不需要上传）**：
- 路径：`G:\yige\validation\1350397700256573018\`
- 包含文件：
  - `band_11.npy` - 红外波段11
  - `band_14.npy` - 红外波段14
  - `band_15.npy` - 红外波段15
  - `human_pixel_masks.npy` - 尾迹云掩码

**航班数据（可以上传）**：
- 文件：`G:\yige\data\flights\validation_flights_matched.csv`
- 大小：24 KB
- 包含：65条航班记录

**排放结果数据（可以上传）**：
- 文件：`G:\yige\data\flights\validation_emissions_results.csv`
- 大小：12 KB
- 包含：65条航班的排放数据

---

## 🌐 通过网页界面操作

### 步骤1：启动服务器

```bash
cd G:\yige\website
双击 start_server.bat
```

或手动启动：
```bash
cd G:\yige\website\backend
python app.py
```

看到以下信息说明成功：
```
Server starting on http://localhost:5000
```

### 步骤2：打开网页

浏览器访问：`http://localhost:5000`

### 步骤3：滚动到 Demo 区域

1. 点击顶部导航栏的 **"Live Demo"**
2. 或直接滚动到页面中间的演示区域

### 步骤4：选择分析类型

在左侧面板中，点击以下任一标签：

- **[Contrail Detection]** - 尾迹云检测
- **[Emission Analysis]** - 排放分析
- **[Carbon Markets]** - 碳市场对比

### 步骤5：上传文件

#### 上传卫星数据（可选）
```
点击 "Upload Satellite Data" 按钮
→ 选择文件（这里网页demo不需要实际上传，已有内置数据）
```

#### 上传航班数据
```
点击 "Upload Flight Data" 按钮
→ 浏览到: G:\yige\data\flights\validation_flights_matched.csv
→ 选择文件
→ 文件名会显示在按钮上
```

### 步骤6：运行分析

```
点击 "Run Analysis" 按钮
→ 按钮显示 "Analyzing..." （3秒）
→ 显示 "Analysis Complete" ✓
```

### 步骤7：查看结果

右侧会显示对应的可视化图表！

---

## 💻 通过API调用（程序化方式）

### 示例1：分析尾迹云

创建文件 `test_contrail_api.py`：

```python
import requests

# API地址
api_url = 'http://localhost:5000/api/analyze/contrail'

# 准备文件
files = {
    'satellite_data': open('G:/yige/validation_metadata_simple.csv', 'rb'),
    'flight_data': open('G:/yige/data/flights/validation_flights_matched.csv', 'rb')
}

# 发送请求
print("正在分析尾迹云...")
response = requests.post(api_url, files=files)

# 关闭文件
for f in files.values():
    f.close()

# 查看结果
if response.status_code == 200:
    result = response.json()
    print("\n✓ 分析成功！")
    print(f"总匹配对数: {result['stats']['total_matches']}")
    print(f"唯一卫星图像: {result['stats']['unique_satellites']}")
    print(f"唯一航班: {result['stats']['unique_flights']}")
    print(f"平均时间差: {result['stats']['avg_time_diff']:.1f} 秒")
else:
    print(f"✗ 错误: {response.status_code}")
    print(response.text)
```

运行：
```bash
cd G:\yige\website
python test_contrail_api.py
```

### 示例2：计算排放

创建文件 `test_emission_api.py`：

```python
import requests
import json

# API地址
api_url = 'http://localhost:5000/api/analyze/emissions'

# 方式1：使用已有的文件
data = {
    'flight_data_file': 'validation_flights_matched.csv',
    'carbon_market': 'EU_ETS'
}

print("正在计算碳排放...")
response = requests.post(api_url,
                        json=data,
                        headers={'Content-Type': 'application/json'})

if response.status_code == 200:
    result = response.json()
    print("\n✓ 计算成功！")
    print(f"总航班数: {result['stats']['total_flights']}")
    print(f"总CO₂排放: {result['stats']['total_co2_tonnes']:.1f} 吨")
    print(f"总燃油消耗: {result['stats']['total_fuel_kg']:.1f} kg")
    print(f"平均排放因子: {result['stats']['avg_emission_factor']:.2f} kg CO₂/km")
    print(f"碳市场成本 (EU ETS): ${result['stats']['total_carbon_cost_usd']:,.2f}")

    print("\n📊 TOP 10 高排放航班:")
    for i, flight in enumerate(result['top_emitters'][:10], 1):
        print(f"{i}. {flight['callsign']} ({flight['typecode']}) - "
              f"{flight['co2_total_kg']/1000:.1f} 吨 CO₂")
else:
    print(f"✗ 错误: {response.status_code}")
    print(response.text)
```

运行：
```bash
python test_emission_api.py
```

### 示例3：对比碳市场

创建文件 `test_markets_api.py`：

```python
import requests

# API地址
api_url = 'http://localhost:5000/api/analyze/carbon-markets'

# 使用已计算的排放结果
data = {
    'results_file': 'emission_results.csv'
}

print("正在对比碳市场...")
response = requests.post(api_url, json=data)

if response.status_code == 200:
    result = response.json()
    print("\n✓ 对比完成！")

    print("\n💰 碳市场成本对比:")
    print("="*70)
    for market in result['markets']:
        print(f"{market['market_name']:40} ${market['total_cost_usd']:>12,.2f}")
        print(f"  碳价: ${market['price_per_tonne_usd']}/吨")
        print()

    print("="*70)
    analysis = result['analysis']
    print(f"最高市场: {analysis['highest_market']} - ${analysis['highest_cost']:,.2f}")
    print(f"最低市场: {analysis['lowest_market']} - ${analysis['lowest_cost']:,.2f}")
    print(f"成本差异: ${analysis['cost_difference']:,.2f}")
    print(f"成本倍数: {analysis['cost_ratio']:.2f}x")
else:
    print(f"✗ 错误: {response.status_code}")
```

运行：
```bash
python test_markets_api.py
```

---

## 📋 完整示例脚本

创建 `complete_demo.py` - 一次运行所有分析：

```python
"""
ContrailTracker 完整演示
展示如何使用API进行端到端分析
"""

import requests
import time
from pathlib import Path

BASE_URL = 'http://localhost:5000/api'

def check_health():
    """检查服务器是否运行"""
    print("🔍 检查服务器状态...")
    try:
        response = requests.get(f'{BASE_URL}/health')
        if response.status_code == 200:
            print("✓ 服务器运行正常\n")
            return True
        else:
            print("✗ 服务器异常\n")
            return False
    except:
        print("✗ 无法连接到服务器")
        print("请先运行: python backend/app.py\n")
        return False

def upload_files():
    """上传文件示例"""
    print("📤 上传航班数据...")

    file_path = Path('../data/flights/validation_flights_matched.csv')

    if not file_path.exists():
        print(f"✗ 文件不存在: {file_path}")
        return None

    with open(file_path, 'rb') as f:
        files = {'file': f}
        response = requests.post(f'{BASE_URL}/upload', files=files)

    if response.status_code == 200:
        result = response.json()
        print(f"✓ 上传成功: {result['filename']}\n")
        return result['filename']
    else:
        print("✗ 上传失败\n")
        return None

def analyze_emissions(carbon_market='EU_ETS'):
    """分析排放"""
    print(f"🔬 分析碳排放 (市场: {carbon_market})...")

    data = {
        'flight_data_file': 'validation_flights_matched.csv',
        'carbon_market': carbon_market
    }

    response = requests.post(f'{BASE_URL}/analyze/emissions', json=data)

    if response.status_code == 200:
        result = response.json()
        stats = result['stats']

        print("✓ 分析完成！")
        print(f"  总航班: {stats['total_flights']}")
        print(f"  总CO₂: {stats['total_co2_tonnes']:.1f} 吨")
        print(f"  碳成本: ${stats['total_carbon_cost_usd']:,.2f}")
        print()
        return result
    else:
        print("✗ 分析失败\n")
        return None

def compare_markets():
    """对比碳市场"""
    print("💰 对比5大碳市场...")

    data = {'results_file': 'emission_results.csv'}
    response = requests.post(f'{BASE_URL}/analyze/carbon-markets', json=data)

    if response.status_code == 200:
        result = response.json()

        print("✓ 对比完成！\n")
        print("市场排名 (按成本从高到低):")
        print("-" * 60)

        for i, market in enumerate(result['markets'], 1):
            print(f"{i}. {market['market_name']:35} ${market['total_cost_usd']:>10,.2f}")

        print("-" * 60)
        analysis = result['analysis']
        print(f"成本差异: {analysis['cost_ratio']:.2f}倍")
        print()
        return result
    else:
        print("✗ 对比失败\n")
        return None

def main():
    """主函数"""
    print("="*70)
    print("ContrailTracker API 完整演示")
    print("="*70)
    print()

    # 1. 检查服务器
    if not check_health():
        return

    # 2. 上传文件（可选）
    # upload_files()
    # time.sleep(1)

    # 3. 分析排放
    emission_result = analyze_emissions('EU_ETS')
    if not emission_result:
        return

    time.sleep(1)

    # 4. 对比市场
    market_result = compare_markets()
    if not market_result:
        return

    # 5. 显示TOP排放航班
    if emission_result and 'top_emitters' in emission_result:
        print("📊 TOP 5 高排放航班:")
        print("-" * 60)
        for i, flight in enumerate(emission_result['top_emitters'][:5], 1):
            callsign = flight.get('callsign', 'N/A')
            typecode = flight.get('typecode', 'N/A')
            co2 = flight.get('co2_total_kg', 0) / 1000
            print(f"{i}. {callsign:10} ({typecode:6}) - {co2:>8.1f} 吨 CO₂")
        print()

    print("="*70)
    print("✓ 演示完成！所有功能正常运行")
    print("="*70)

if __name__ == "__main__":
    main()
```

运行完整演示：
```bash
cd G:\yige\website
python complete_demo.py
```

预期输出：
```
======================================================================
ContrailTracker API 完整演示
======================================================================

🔍 检查服务器状态...
✓ 服务器运行正常

🔬 分析碳排放 (市场: EU_ETS)...
✓ 分析完成！
  总航班: 65
  总CO₂: 2196.9 吨
  碳成本: $208,707.48

💰 对比5大碳市场...
✓ 对比完成！

市场排名 (按成本从高到低):
------------------------------------------------------------
1. EU Emissions Trading System       $208,707.48
2. California Cap-and-Trade           $65,908.00
3. ICAO CORSIA                        $43,938.00
4. Regional Greenhouse Gas Initiative $32,954.00
5. China Carbon Market                $24,166.00
------------------------------------------------------------
成本差异: 8.64倍

📊 TOP 5 高排放航班:
------------------------------------------------------------
1. AIC144     (B77W  ) -    131.1 吨 CO₂
2. AAL6813    (B77W  ) -    130.3 吨 CO₂
3. BAW117     (B77W  ) -    109.8 吨 CO₂
4. UAE201     (B77W  ) -    108.5 吨 CO₂
5. TAP201     (A332  ) -     97.6 吨 CO₂

======================================================================
✓ 演示完成！所有功能正常运行
======================================================================
```

---

## 📂 数据文件格式说明

### 航班数据CSV格式

文件：`validation_flights_matched.csv`

必需字段：
```csv
icao24,callsign,typecode,latitude_1,longitude_1,altitude_1,latitude_2,longitude_2,altitude_2,record_id
a12345,UAL123,B737,40.64,-73.80,10000,37.70,-72.61,11000,1350397700256573018
```

字段说明：
- `icao24`: 飞机唯一标识
- `callsign`: 航班呼号
- `typecode`: 飞机型号
- `latitude_1`, `longitude_1`: 起点坐标
- `altitude_1`: 起点高度（米）
- `latitude_2`, `longitude_2`: 终点坐标
- `altitude_2`: 终点高度（米）
- `record_id`: 关联的卫星图像ID

### 排放结果CSV格式

文件：`validation_emissions_results.csv`

字段：
```csv
icao24,callsign,typecode,flight_distance_km,co2_total_kg,fuel_burn_kg,emission_factor_kg_per_km,carbon_cost_usd
a12345,UAL123,B737,3200,34500,10925,10.78,3277.50
```

---

## 🎯 测试清单

测试所有功能是否正常：

- [ ] 服务器启动成功 (`http://localhost:5000`)
- [ ] 网页正常显示
- [ ] Demo区域3个标签可以切换
- [ ] 文件上传按钮可以点击
- [ ] "Run Analysis" 按钮有响应
- [ ] API健康检查成功 (`/api/health`)
- [ ] 排放分析API工作正常
- [ ] 碳市场对比API工作正常

---

## 💡 实用技巧

### 技巧1：使用curl快速测试

```bash
# 健康检查
curl http://localhost:5000/api/health

# 获取统计
curl http://localhost:5000/api/stats

# 测试联系表单
curl -X POST http://localhost:5000/api/contact \
  -H "Content-Type: application/json" \
  -d "{\"name\":\"测试\",\"email\":\"test@test.com\",\"message\":\"测试消息\"}"
```

### 技巧2：批量处理多个文件

```python
import os
import requests

# 批量上传多个CSV文件
data_dir = Path('../data/flights')
for csv_file in data_dir.glob('*.csv'):
    with open(csv_file, 'rb') as f:
        files = {'file': f}
        response = requests.post('http://localhost:5000/api/upload', files=files)
        print(f"上传 {csv_file.name}: {response.status_code}")
```

### 技巧3：导出结果到文件

```python
import json

# 获取分析结果并保存
response = requests.post('http://localhost:5000/api/analyze/emissions',
                        json={'flight_data_file': 'validation_flights_matched.csv'})

if response.status_code == 200:
    with open('analysis_results.json', 'w', encoding='utf-8') as f:
        json.dump(response.json(), f, indent=2, ensure_ascii=False)
    print("结果已保存到 analysis_results.json")
```

---

## ❓ 常见问题

**Q: 上传大文件（>100MB）失败？**
A: 修改 `backend/app.py` 中的 `MAX_CONTENT_LENGTH` 配置

**Q: API返回500错误？**
A: 检查后端控制台的错误信息，确保数据文件路径正确

**Q: 如何上传.npy格式的卫星数据？**
A: 当前API主要处理CSV格式，.npy文件由后端直接读取validation目录

---

**准备好开始测试了吗？启动服务器，试试上面的示例！** 🚀
